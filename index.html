<!DOCTYPE html>
<html>

<head>
    <title>Scrum Poker</title>
    <link href="/static/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <style>
        .dot {
            height: 25px;
            width: 25px;
            background-color: #bbb;
            border-radius: 50%;
            display: inline-block;
        }

        .dot-connected {
            background-color: rgb(107, 236, 90);
        }
    </style>
    <div class="container mt-5" id="join-area">
        <div class="row g-3">
            <div class="col">
                <input class="form-control-lg" id="room-id" type="text" placeholder="Enter room id" />
                <input class="form-control-lg" id="user-id" type="text" placeholder="Enter your name" />
                <button class="btn-lg btn-primary" onclick="join()" type="button">Join</button>
            </div>
        </div>
    </div>
    <div id="vote-area" style="display:none;">
        <div class="container mt-5">
            <div class="row h5">
                <div class="col-1"><span id="connection-status" class="dot"></span></div>
                <div class="col-3">Room id:<span id="room-id-display">[11111]</span></div>
                <div class="col">User name: <span id="user-id-display">[Henke]</span></div>
            </div>
        </div>
        <div class="container mt-5">
            <div class="row">
                <div class="col-auto me-auto">
                    <div class="input-group">
                        <select class="form-select" id="vote-select" aria-label="select number">
                            <option selected value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="5">5</option>
                            <option value="8">8</option>
                            <option value="13">13</option>
                            <option value="20">20</option>
                            <option value="40">40</option>
                            <option value="100">100</option>
                        </select>
                        <button class="btn-lg btn-primary" onclick="vote()" type="button">Vote</button>
                    </div>
                </div>
                <div class="col-auto">
                    <button class="btn-lg btn-primary btn-success" onclick="reveal()" type="button">Reveal</button>
                    <button class="btn-lg btn-primary btn-warning ms-5" onclick="clearVotes()"
                        type="button">Clear</button>
                </div>
            </div>
            <div class="row">
                <div class="col mt-5" id="state-list"></div>
            </div>
        </div>
    </div>

    <script>
        // var input = document.getElementById("input");
        // var output = document.getElementById("output");
        // var socket = new WebSocket("ws://localhost:8080/echo");

        // socket.onopen = function () {
        //     output.innerHTML += "Status: Connected\n";
        // };

        // socket.onmessage = function (e) {
        //     output.innerHTML += "Server: " + e.data + "\n";
        // };

        // function send() {
        //     socket.send(input.value);
        //     input.value = "";
        // }

        var socket;

        var state = {
            connected: false,
            roomId: "",
            userId: "",
            id: "",
            revealed: false,
            users: []
        };

        function displayState() {
            var output = document.getElementById('state-list');
            var stateHtml = "";
            for (var i = 0; i < state.users.length; i++) {
                var vote = state.users[i].vote !== "" ? "✔️" : "🤔";
                if (state.revealed) {
                    vote = state.users[i].vote;
                }
                stateHtml += "<div class='border-top p-3 row mt-3 h4'><div class='col'>" +
                    state.users[i].userId
                    + "</div><div class='col'>" +
                    vote
                    + "</div></div>";
            }
            output.innerHTML = stateHtml;

            var roomId = document.getElementById('room-id-display');
            roomId.innerText = state.roomId;
            var userId = document.getElementById('user-id-display');
            userId.innerText = state.userId;

            var connectedIcon = document.getElementById('connection-status');
            if(state.connected) {
                connectedIcon.classList.add('dot-connected');
            } else {
                connectedIcon.classList.remove('dot-connected');
            }
        }

        function vote() {
            var voteSelect = document.getElementById('vote-select');
           
            socket.send("vote:" + state.id + ":" + state.userId + ":" + voteSelect.value);

            // update state
            displayState();
        }

        function reveal() {
            // update state
            // TEMP:
            socket.send("reveal:" + state.id + ":" + state.userId);
            //state.revealed = true;
            // 
            displayState();
        }

        function clearVotes() {
            // update state
            // TEMP:
            
            socket.send("clear:" + state.id + ":" + state.userId);
            
            // for (var i = 0; i < state.users.length; i++) {
            //     state.users[i].vote = "";
            // }
            // state.revealed = false;
            // socket.send(state.userId + ":clear");
            //
            displayState();
        }

        function messageRecieved(e) {
            console.log(e.data);

            const dataRecieved = e.data.split(":");
            const roomId = dataRecieved[1];
            const id = dataRecieved[2];
            const userId = dataRecieved[3];
            const vote = dataRecieved[4];
            switch (dataRecieved[0]) {
                case "myinfo":
                case "joined":
                    state.id = id;
                    
                    state.users.push({
                        roomId: roomId,
                        id: id,
                        userId: userId,
                        vote: vote
                    });
                    break;
                case "vote":
                    console.log(dataRecieved[3] + " voted");
                    // .find or w/e
                    state.users.forEach(u => {
                        if(u.userId == userId) {
                            u.vote = vote;
                        }
                    });
                    break;
                case "reveal":
                    console.log(dataRecieved[3] + " revealed");
                    state.revealed = true;
                    break;
                case "clear":
                    console.log(dataRecieved[3] + " cleared");
                    state.revealed = false;
                    state.users.forEach(u => {
                       u.vote = "";
                    });
                    break;
            }

            displayState();
        }

        function join() {
            var joinArea = document.getElementById('join-area');
            joinArea.style.display = 'none';
            var voteArea = document.getElementById('vote-area');
            voteArea.style.display = 'block';

            var roomId = document.getElementById('room-id');
            state.roomId = roomId.value;
            var userId = document.getElementById('user-id');
            state.userId = userId.value;

            const loc = window.location;
            let websocket_uri = "";
            if (loc.protocol === "https:") {
                websocket_uri = "wss:";
            } else {
                websocket_uri = "ws:";
            }
            websocket_uri += "//" + loc.host + "/voting/";
            //websocket_uri += loc.pathname + "/voting/";

            socket = new WebSocket(websocket_uri + state.roomId + "?userId=" + state.userId);

            socket.onmessage = messageRecieved;

            socket.onopen = function (event) {
                state.connected = true;
                displayState();
            };

            socket.onclose = function(event) {
                state.connected = false;
                displayState();
            };
        }

    </script>
</body>

</html>